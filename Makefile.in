# Makefile for pam_afs_session

srcdir		= @srcdir@
VPATH		= @srcdir@

PACKAGE		= @PACKAGE_TARNAME@
VERSION		= @PACKAGE_VERSION@
TARDIR		= $(PACKAGE)-$(VERSION)
TARNAME		= $(TARDIR).tar

prefix		= @prefix@
exec_prefix	= @exec_prefix@
libdir		= @libdir@
pamdir		= $(libdir)/security
datarootdir	= @datarootdir@
mandir		= @mandir@

CC		= @CC@
CFLAGS		= @CFLAGS@
CPPFLAGS	= -I. -I$(srcdir) @CPPFLAGS@
LDFLAGS		= @LDFLAGS@
LIBS		= -lpam @LIBS@

INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@

SOURCES		= logging.c options.c public.c tokens.c
OBJECTS		= $(SOURCES:.c=.o) @LIBOBJS@

all: pam_afs_session.so $(srcdir)/pam_afs_session.5

pam_afs_session.so: $(OBJECTS)
	$(CC) -o $@ $(LDFLAGS) $(OBJECTS) $(LIBS)
	chmod 644 $@

$(srcdir)/pam_afs_session.5: $(srcdir)/pam_afs_session.pod
	pod2man --section=5 --release=$(VERSION) --center='PAM Modules' \
	    $(srcdir)/pam_afs_session.pod > $@

install: pam_afs_session.so $(srcdir)/pam_afs_session.5
	$(INSTALL) -d $(pamdir)
	$(INSTALL) -d $(mandir)/man5
	$(INSTALL_DATA) pam_afs_session.so $(pamdir)/pam_afs_session.so
	$(INSTALL_DATA) $(srcdir)/pam_afs_session.5 \
	    $(mandir)/man5/pam_afs_session.5

# This target only works when builddir == srcdir, at least for now.
dist: pam_afs_session.5
	rm -rf $(TARDIR) $(TARNAME).gz
	mkdir $(TARDIR)
	bzr log --short > CHANGES
	rsync -C --exclude /debian/ -a ./ $(TARDIR)/
	cd $(TARDIR) && ./autogen
	tar cf $(TARNAME) $(TARDIR)
	gzip -9 $(TARNAME)

clean:
	rm -f *.so *.o

distclean: clean
	rm -f Makefile config.cache config.h config.log config.status
	rm -rf $(TARDIR)

maintclean maintainer-clean: distclean
	rm -f CHANGES config.h.in config.h.in~ configure pam_afs_session.5
	rm -f $(TARNAME).gz
